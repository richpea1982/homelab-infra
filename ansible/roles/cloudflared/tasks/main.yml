---
- name: Create Cloudflared directory
  file:
    path: /opt/cloudflared
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Write Cloudflare tunnel credentials file
  copy:
    content: "{{ cloudflare_tunnel_credentials }}"
    dest: "/opt/cloudflared/{{ cloudflare_tunnel_id }}.json"
    mode: '0644'

- name: Deploy Cloudflared config
  template:
    src: config.yml.j2
    dest: /opt/cloudflared/config.yml
    mode: '0644'

- name: Deploy Cloudflared docker-compose
  template:
    src: docker-compose.yml.j2
    dest: /opt/cloudflared/docker-compose.yml
    mode: '0644'

- name: Start Cloudflared
  community.docker.docker_compose_v2:
    project_src: /opt/cloudflared
    state: present

- name: Create DNS records for all domains
  community.general.cloudflare_dns:
    zone: "{{ item.zone }}"
    record: "{{ item.record }}"
    type: CNAME
    value: "{{ cloudflare_tunnel_id }}.cfargotunnel.com"
    proxied: true
    api_token: "{{ CLOUDFLARE_API_DNS_TOKEN }}"
  loop:
    # egliseesperanceagde.fr
    - { zone: "egliseesperanceagde.fr", record: "@" }
    - { zone: "egliseesperanceagde.fr", record: "www" }

    # egliseesperanceagde.org
    - { zone: "egliseesperanceagde.org", record: "@" }
    - { zone: "egliseesperanceagde.org", record: "www" }

    # petitsanglaisabeziers.fr
    - { zone: "petitsanglaisabeziers.fr", record: "@" }
    - { zone: "petitsanglaisabeziers.fr", record: "www" }

    # pearsalls.online (root + wildcard + traefik)
    - { zone: "pearsalls.online", record: "@" }
    - { zone: "pearsalls.online", record: "*" }
    - { zone: "pearsalls.online", record: "traefik" }

- name: Start cloudflared via Docker Compose
  ansible.builtin.command:
    cmd: docker compose up -d
    chdir: /opt/cloudflared
