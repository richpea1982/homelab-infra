---
# ---------------------------------------------------------
# 1. Create DNS records for Cloudflared-enabled services
# ---------------------------------------------------------
- name: Build flattened DNS records list
  set_fact:
    cf_dns_records: >-
      {{
        services
        | dict2items
        | selectattr('value.cloudflared_enabled', 'equalto', true)
        | list
        | product(
            ((item.value.domains | default([])) +
             (item.value.nginx.domains | default([])))
          )
        | map('combine', [{
            'service': item.0.value,
            'service_key': item.0.key,
            'domain': item.1
          }])
        | list
      }}

- name: Create DNS records for Cloudflared-enabled services
  community.general.cloudflare_dns:
    zone: "{{ item.service.cloudflare_zone | default(primary_domain) }}"
    record: >-
      {{
        item.domain
        | regex_replace('\\.' ~ (item.service.cloudflare_zone | default(primary_domain)) ~ '$', '')
        | trim('.')
        | default('@')
      }}
    type: CNAME
    value: "{{ cloudflare_tunnel_hostname }}"
    ttl: 1
    proxied: true
    api_token: "{{ CLOUDFLARE_API_DNS_TOKEN }}"
  loop: "{{ cf_dns_records }}"
  loop_control:
    label: "DNS {{ item.domain }} -> {{ item.service_key }}.{{ item.service.cloudflare_zone | default(primary_domain) }}"
  notify: restart cloudflared

# ---------------------------------------------------------
# 2. Deploy Cloudflared ingress configuration
# ---------------------------------------------------------
- name: Deploy Cloudflared ingress config
  template:
    src: config.yml.j2
    dest: /opt/cloudflared/config.yml
    mode: '0644'
  notify: restart cloudflared
