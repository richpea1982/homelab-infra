services:
  traefik:
    image: traefik:v3.6
    container_name: traefik
    restart: always
    user: "0:{{ docker_group_gid }}"

    ports:
      - "443:443"
      - "80:80"
      - "8080:8080"

    networks:
{% for net in services.traefik.networks %}
      - {{ net }}
{% endfor %}

    labels:
      - "traefik.enable=true"

{% if services.traefik.traefik_enabled %}
{% for domain in services.traefik.domains %}
      - "traefik.http.routers.traefik.rule=Host(`{{ domain }}`)"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.tls=true"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.services.traefik.loadbalancer.server.port=8080"
{% endfor %}
{% endif %}

    volumes:
      # Required bind mounts (old working config)
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /opt/traefik/traefik.yml:/traefik.yml:ro
      - /opt/traefik/dynamic:/dynamic:ro
      - /opt/traefik/certs:/certs:ro
      - /opt/traefik/logs:/logs

      # ACME storage (named volume)
{% for vol in services.traefik.volumes %}
      - {{ vol }}:/data
{% endfor %}

    command:
      - "--configFile=/traefik.yml"

  crowdsec:
    image: crowdsecurity/crowdsec:latest
    container_name: crowdsec
    restart: always

    networks:
{% for net in services.crowdsec.networks %}
      - {{ net }}
{% endfor %}

    volumes:
{% for vol in services.crowdsec.volumes %}
      - {{ vol }}:/var/lib/crowdsec/data
{% endfor %}
      - /opt/traefik/logs:/var/log/traefik:ro

    environment:
      - COLLECTIONS=crowdsecurity/traefik
      - TZ=Europe/Paris

{% set all_networks = (services.traefik.networks + services.crowdsec.networks) | unique %}

networks:
{% for net in all_networks %}
  {{ net }}:
    external: true
{% endfor %}

{% set all_volumes = (services.traefik.volumes + services.crowdsec.volumes) | unique %}

volumes:
{% for vol in all_volumes %}
  {{ vol }}:
    external: true
{% endfor %}

