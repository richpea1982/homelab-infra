---
# ----------------------------------------
# MINIO DIRECTORIES
# ----------------------------------------
- name: Create MinIO base directory
  ansible.builtin.file:
    path: /opt/minio
    state: directory
    mode: '0755'

# ----------------------------------------
# DOCKER COMPOSE
# ----------------------------------------
- name: Deploy MinIO docker-compose.yml
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: /opt/minio/docker-compose.yml
    mode: '0644'
  notify: restart minio

# ----------------------------------------
# START STACK
# ----------------------------------------
- name: Start MinIO stack
  community.docker.docker_compose_v2:
    project_src: /opt/minio
    state: present
# ----------------------------------------
# CREATE TERRAFORM STATE BUCKET
# ----------------------------------------
- name: Create terraform-state bucket
  community.docker.docker_container:
    name: minio-mc-init
    image: minio/mc:latest
    auto_remove: true
    detach: false
    entrypoint: ["/bin/sh", "-c"]
    command: "mc alias set local http://minio:9000 {{ minio_root_user }} {{ minio_root_password }} && mc mb --ignore-existing local/terraform-state"
    networks:
      - name: minio_default
  become: false
